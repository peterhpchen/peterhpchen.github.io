---
layout: post
title: 第一個Android NDK(Java call C)
date: '2014-05-15T21:11:00.000-07:00'
author: Peter
tags:
- Android Studio
- NDK
- Android
modified_time: '2014-05-16T08:08:23.146-07:00'
thumbnail: http://3.bp.blogspot.com/-7z2GTg_5woU/U3R4U0c1tjI/AAAAAAAAAR4/fZ2s2-lGIqE/s72-c/%E4%B8%8B%E8%BC%89NDK.bmp
blogger_id: tag:blogger.com,1999:blog-8081092262828660128.post-5940965304944436059
blogger_orig_url: https://limitlessping.blogspot.com/2014/05/android-ndkjava-call-c.html
permalink: /:year/:month/:title:output_ext
---

最近因為要在Android中使用到C Library，查了一下發現NDK這個工具，它讓Java可以去呼叫C，讓我們在Android的專案中也可以使用C Library。<br /><h2>環境</h2><div><ul><li>Windows 8.1(64bits)</li><li>Android Studio 0.58</li><li>Android NDK Revision 9d</li><li>ASUS Nexus 7-Android 4.4.2(API 19)</li></ul><h2>目的</h2><div>我們要利用Java去呼叫C的方法，然後將取到的字串輸出。</div><h2>步驟</h2></div><h3>1. 下載NDK</h3>到<a href="https://developer.android.com/tools/sdk/ndk/index.html">https://developer.android.com/tools/sdk/ndk/index.html</a>下載符合自己系統的NDK，這裡我們下載<span style="background-color: #f7f7f7; color: #222222; font-family: Roboto, sans-serif; line-height: 19px;">Windows 64-bit的NDK，目前的版本是9d。</span><br /><div style="text-align: left;"><a href="http://3.bp.blogspot.com/-7z2GTg_5woU/U3R4U0c1tjI/AAAAAAAAAR4/fZ2s2-lGIqE/s1600/%E4%B8%8B%E8%BC%89NDK.bmp" imageanchor="1" style="clear: left; margin-bottom: 1em;"><img border="0" src="http://3.bp.blogspot.com/-7z2GTg_5woU/U3R4U0c1tjI/AAAAAAAAAR4/fZ2s2-lGIqE/s1600/%E4%B8%8B%E8%BC%89NDK.bmp" height="220" width="400" /></a></div><div style="text-align: left;">載好之後隨便放一個地方，記得路徑以便等下使用(我的路徑為C:\Android\android-ndk-r9d)。<br /><h3>2. 新增native宣告C的方法</h3><div>在MainActivity.java中打入上面的程式碼，宣告完native function之後要先build，要不然等下的javah會找不到這個方法導致遺漏。</div></div><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=native.java"></script> <br /><h3 style="text-align: left;">3. 使用javah</h3><div>先簡單講解javah的使用方式，它可以幫我們產生C header file以便讓我們可以在.java中找到對應的方法。<br /><h4>開啟Terminal</h4><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-pJL50qvgzqI/U3WGBe6OBvI/AAAAAAAAASI/sc69FtFmdwo/s1600/%E9%96%8B%E5%95%9Fterminal.bmp" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-pJL50qvgzqI/U3WGBe6OBvI/AAAAAAAAASI/sc69FtFmdwo/s1600/%E9%96%8B%E5%95%9Fterminal.bmp" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Tools &gt; Open Terminal</td></tr></tbody></table><h4>將所在目錄轉到main</h4><h4>鍵入javah的指令產生.h</h4><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=javah"></script> <br /><ul><li>-d directory(你要儲存的目錄)</li><li>-classpath path(javah需要的classes(SDK及project的class路徑))</li></ul><div>PS:如果找不到javah的話會產生下面的錯誤</div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-3xNIxzVkuUk/U3WPLl3fy4I/AAAAAAAAASU/Y9-TQwZNuqg/s1600/%E6%89%BE%E4%B8%8D%E5%88%B0javah.bmp" imageanchor="1"><img border="0" src="http://3.bp.blogspot.com/-3xNIxzVkuUk/U3WPLl3fy4I/AAAAAAAAASU/Y9-TQwZNuqg/s1600/%E6%89%BE%E4%B8%8D%E5%88%B0javah.bmp" height="47" width="400" /></a></div>在環境變數裡加上javah的路徑就可解決</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-BCL1nUPolIY/U3WPguY0cyI/AAAAAAAAASc/EkNd4biGk4Q/s1600/add+javah+path.bmp" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-BCL1nUPolIY/U3WPguY0cyI/AAAAAAAAASc/EkNd4biGk4Q/s1600/add+javah+path.bmp" height="25" width="400" /></a></div><div><br /><h3>4. 加入main.c</h3><div>如果上面的native有被build的話，你的.h中應該會有{your package}_{native function}(我的就是<b><i>Java_com_hpchen_testndk_app_MainActivity_getStringFromNative</i></b>)。</div><div>PS:如果<b>沒有</b>請clean project，刪掉jni資料夾，rebuild之後再把第3步重做一次。</div><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=main.c"></script> <br /><div><ul><li>記得include .h</li><li>將.h中的native function寫好</li></ul><h3>5. 加入util.c</h3></div><div>加入一個空的util.c</div><h3>6. local.properties中加入ndk路徑</h3><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=addNDK"></script> <br /><div>將第1步記下的路徑加入local.properties</div><h3>7.&nbsp;build.gradle中加入ndk參考</h3><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=addNDKGradle"></script> <br /><div>注意:是<b>app</b>中的build.gradle，<b>不是</b>project的。</div><h3>8. 在MainActivity中load library</h3><script src="https://gist.github.com/CodingCodeChen/5e8e8ad8b81b3fd4d16d.js?file=loadLibrary.java"></script> <br /><div>執行之後就會看到"Hello JNI !"了。<br /><h2>參考</h2></div></div><div><a href="https://www.youtube.com/watch?v=okLKfxfbz40">https://www.youtube.com/watch?v=okLKfxfbz40</a></div><div><br /></div>