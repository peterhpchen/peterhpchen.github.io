---
layout: post
title: WebRTC首部曲-getUserMedia
date: '2014-03-29T02:57:00.002-07:00'
author: Peter
tags:
- JavaScript
- HTML
- WebRTC
modified_time: '2014-03-29T02:57:47.517-07:00'
thumbnail: http://2.bp.blogspot.com/-cKbz-TVVsi0/UzaNXeajsfI/AAAAAAAAAFs/jtdmJP4dW5I/s72-c/error.bmp
blogger_id: tag:blogger.com,1999:blog-8081092262828660128.post-1302675139831074844
blogger_orig_url: https://limitlessping.blogspot.com/2014/03/webrtc-getusermedia.html
permalink: /:year/:month/:title:output_ext
---

之前已經看過了WebRTC的一些背景知識，現在就來看看要如何實作吧，首先我們要介紹的是getUserMedia，這個API是為了要讓broswer可以取得攝影機及麥克風的訊息，以前我們要使用攝影機通常都還是要安裝一些應用程式才能抓到攝影機及麥克風，可是getUserMedia不須安裝任何插件，哈哈，是不是很方便阿。<br /><br />我們先來看一下getUserMedia這位主角的基本資料 :<br /><br /><h2><span style="font-size: x-large;">Syntax</span></h2><script src="https://gist.github.com/CodingCodeChen/9850333.js?file=syntax.js"></script> <br /><div><h2><span style="font-size: x-large;">Parameter</span></h2></div><div><ul><li><span lang="EN-US" style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;;"><b>constraints</b> : 設定media type</span></li><li><span lang="EN-US" style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;;"><span lang="EN-US"><b>successCallback</b> : 當成功取得media stream所做的function</span></span></li><li><span lang="EN-US" style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;;"><span lang="EN-US"><span lang="EN-US"><b>errorCallback</b> : 當發生錯誤時做此function</span></span></span></li></ul><div><span style="font-family: Times New Roman, serif;">來看一下這個getUserMedia，它本身有三個parameters :&nbsp;</span><br /><span style="font-family: Times New Roman, serif;"><br /></span><span style="font-family: Times New Roman, serif;"><b>constraints</b>是對這個media type所做的設定，像是要取得影像還是聲音等等...。</span><br /><span style="font-family: Times New Roman, serif;"><br /></span><span style="font-family: Times New Roman, serif;"><b>successCallback</b>是成功取得media stream之後要做的function，像是我們可能會想要把影像放到&lt;video&gt;裡顯示在網頁上。</span><br /><span style="font-family: Times New Roman, serif;"><br /></span><span style="font-family: Times New Roman, serif;">而最後一個就是我們最不想看到的<b>errorCallback</b>了，如果錯誤發生(QQ)就會執行這個，這裡面可以擺一些補救措施，例如視訊發生錯無時會撥放別的影片，也可以用log紀錄錯誤訊息。</span><br /><span style="font-family: Times New Roman, serif;"><br /></span><h2><span style="font-family: Times New Roman, serif; font-size: x-large;">Demo</span></h2></div></div><div><span style="font-family: Times New Roman, serif;">這個demo所要做的就是要單純的把攝影機及麥克風所取得的資訊顯示在網頁上。</span></div><h3><span style="font-family: Times New Roman, serif; font-size: large;">Step1</span></h3><div>首先我們要先讓media stream在網頁上有一個&lt;video&gt;(舞台)，這樣它才能大顯身手 :<br /><script src="https://gist.github.com/CodingCodeChen/9850333.js?file=demo.html"></script> <b>注意</b> : 一定要把autoplay設好，要不然影像會被定格喔。<br /><br /><h3><span style="font-size: large;">Step2</span></h3></div><div>再來就是這次的重點了，我們要設定好3個parameters，才能使getUserMedia乖乖運轉不出錯 :&nbsp;</div><div><script src="https://gist.github.com/CodingCodeChen/9850333.js?file=getUserMedia.js"></script>這裡我們將constraints中的audio和video的屬性值都設為true，表示我們要取得audio和video，success中我們要將傳回來的stream放到&lt;video&gt;中，在這裡因為這個stream是一個Blob object，所以我們要將這個object轉成src可以吃的URL，這樣我們的&lt;video&gt;才不會拉肚子，最後我們在error中輸出log。<br /><br /><b>注意</b>&nbsp;: 有些人會懶得設定errorCallBack，但是我建議養成好習慣至少印出log，這樣在debug的時候會輕鬆很多唷(我自己就是血淋淋的例子@@)。<br /><br />做到這裡先來讓它跑一下吧，應該會出現以下的<span style="color: red;">錯誤</span> :<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-cKbz-TVVsi0/UzaNXeajsfI/AAAAAAAAAFs/jtdmJP4dW5I/s1600/error.bmp" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-cKbz-TVVsi0/UzaNXeajsfI/AAAAAAAAAFs/jtdmJP4dW5I/s1600/error.bmp" height="67" width="400" /></a></div><br /><br /><br /><br /><br /><br /><br />會發生這個錯誤是因為跨遊覽器的問題，getUserMedia在不同的browser中有不同的名字，像在chrome叫做webkitGetUserMedia，在FireFox中叫做mozGetUserMedia，這種情形其實並不少見，因此就產生了<a href="http://modernizr.com/">modernizr</a>這個方便的小工具，它可以處理網頁跨平台所產生的問題，這邊我們先不使用<a href="http://modernizr.com/">modernizr</a>，我們使用下列判斷來處理這個問題 :<br /><script src="https://gist.github.com/CodingCodeChen/9850333.js?file=featureDetection.js"></script> <br /><h3><span style="font-size: large;">Step3</span></h3></div><div>在browser上執行，你應該會看到下面的提醒 :<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-3qHmq-7kyEQ/UzaUTH8Sj0I/AAAAAAAAAF8/OJJz61GwZBs/s1600/Toast.bmp" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-3qHmq-7kyEQ/UzaUTH8Sj0I/AAAAAAAAAF8/OJJz61GwZBs/s1600/Toast.bmp" height="30" width="400" /></a></div><br /><br /><br /><br />按下允許之後就會出現你帥氣(漂亮)的臉了。<br /><br /><h2><span style="font-size: x-large;">結論</span></h2></div><div>這次的demo讓我們學習到了要如何藉由browser去存取webcam及mic，而getUserMedia它傳回的是一個stream，所以你當然可以對它做一些處理(像是淡化、銳化、長寬等等)，但是這個主題的重點沒有放在那裏，所以我就先不說了，今天就先到這裡，再見嘍。</div><div><br /></div><h2><span style="font-size: x-large;">參考資料</span></h2><div><a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/">Capturing Audio and Video in HTML5</a></div>